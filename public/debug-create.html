<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Create Product - Paageming</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .response { background: #f8f9fa; padding: 10px; margin-top: 10px; border-radius: 3px; font-family: monospace; white-space: pre-wrap; }
        button { background: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 3px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        input, textarea, select { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px; }
        .debug { background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Debug Create Product</h1>
        
        <div class="debug">
            <strong>Debug Information:</strong>
            <div id="debug-info">Loading...</div>
        </div>
        
        <div class="section">
            <h3>Step 1: Test Admin Login</h3>
            <button onclick="testLogin()">Test Login</button>
            <div id="login-status" class="response"></div>
        </div>
        
        <div class="section">
            <h3>Step 2: Test API Connection</h3>
            <button onclick="testAPI()">Test API Endpoints</button>
            <div id="api-status" class="response"></div>
        </div>
        
        <div class="section">
            <h3>Step 3: Create Product (Debug Mode)</h3>
            <form id="product-form">
                <input type="text" id="product-name" placeholder="Product Name" value="Test Product Debug">
                <textarea id="product-description" placeholder="Description">Test product for debugging</textarea>
                <input type="number" id="product-price" placeholder="Price" value="25000">
                <input type="number" id="product-stock" placeholder="Stock" value="50">
                <select id="product-category">
                    <option value="">Select Category</option>
                    <option value="1" selected>Sayuran</option>
                    <option value="2">Buah-buahan</option>
                    <option value="3">Biji-bijian</option>
                    <option value="4">Rempah-rempah</option>
                </select>
                <input type="url" id="product-image" placeholder="Image URL" value="https://via.placeholder.com/300x300.png?text=Test">
                <button type="button" onclick="debugCreateProduct()">üîß Debug Create Product</button>
                <button type="submit">üöÄ Submit Form</button>
            </form>
            <div id="create-status" class="response"></div>
        </div>
        
        <div class="section">
            <h3>Step 4: Manual API Test</h3>
            <button onclick="manualAPITest()">Manual Create Product API</button>
            <div id="manual-status" class="response"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000/api';
        let authToken = '';
        let debugLog = [];

        function addDebugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.push(`[${timestamp}] ${message}`);
            document.getElementById('debug-info').innerHTML = debugLog.slice(-10).join('<br>');
            console.log(message);
        }

        // Initialize debug
        window.addEventListener('load', () => {
            addDebugLog('üîß Debug page loaded');
            
            // Check if form elements exist
            const form = document.getElementById('product-form');
            const nameInput = document.getElementById('product-name');
            
            addDebugLog(`‚úÖ Form found: ${form ? 'Yes' : 'No'}`);
            addDebugLog(`‚úÖ Name input found: ${nameInput ? 'Yes' : 'No'}`);
            
            // Add form submit listener
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                addDebugLog('üìù Form submitted via event listener');
                debugCreateProduct();
            });
        });

        async function testLogin() {
            addDebugLog('üîê Testing admin login...');
            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'admin@panenku.com',
                        password: 'password123'
                    })
                });
                
                addDebugLog(`üì° Login response status: ${response.status}`);
                const data = await response.json();
                
                if (data.token) {
                    authToken = data.token;
                    addDebugLog(`‚úÖ Login successful! Token: ${data.token.substring(0, 20)}...`);
                    document.getElementById('login-status').innerHTML = 
                        `‚úÖ LOGIN SUCCESS\nUser: ${data.user.name}\nRole: ${data.user.role}\nToken: ${data.token.substring(0, 50)}...`;
                } else {
                    addDebugLog(`‚ùå Login failed: ${JSON.stringify(data)}`);
                    document.getElementById('login-status').innerHTML = 
                        `‚ùå LOGIN FAILED\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                addDebugLog(`‚ùå Login error: ${error.message}`);
                document.getElementById('login-status').innerHTML = `‚ùå ERROR: ${error.message}`;
            }
        }

        async function testAPI() {
            addDebugLog('üß™ Testing API endpoints...');
            try {
                // Test products endpoint
                const productsResponse = await fetch(`${API_BASE}/products`);
                addDebugLog(`üì° Products API status: ${productsResponse.status}`);
                
                // Test categories endpoint
                const categoriesResponse = await fetch(`${API_BASE}/categories`);
                addDebugLog(`üì° Categories API status: ${categoriesResponse.status}`);
                
                document.getElementById('api-status').innerHTML = 
                    `‚úÖ API CONNECTION TEST\n` +
                    `Products endpoint: ${productsResponse.status}\n` +
                    `Categories endpoint: ${categoriesResponse.status}\n` +
                    `Base URL: ${API_BASE}`;
                    
            } catch (error) {
                addDebugLog(`‚ùå API test error: ${error.message}`);
                document.getElementById('api-status').innerHTML = `‚ùå API ERROR: ${error.message}`;
            }
        }

        async function debugCreateProduct() {
            addDebugLog('üöÄ Starting product creation debug...');
            
            // Check if logged in
            if (!authToken) {
                addDebugLog('‚ùå No auth token found, attempting login...');
                await testLogin();
                if (!authToken) {
                    document.getElementById('create-status').innerHTML = '‚ùå LOGIN REQUIRED: Please test login first';
                    return;
                }
            }
            
            // Get form data
            const productData = {
                name: document.getElementById('product-name').value,
                description: document.getElementById('product-description').value,
                price: parseInt(document.getElementById('product-price').value),
                stock: parseInt(document.getElementById('product-stock').value),
                category_id: parseInt(document.getElementById('product-category').value),
                image: document.getElementById('product-image').value
            };
            
            addDebugLog(`üìù Product data: ${JSON.stringify(productData)}`);
            
            // Validate data
            if (!productData.name || !productData.description || !productData.price || !productData.stock || !productData.category_id) {
                addDebugLog('‚ùå Validation failed: Missing required fields');
                document.getElementById('create-status').innerHTML = '‚ùå VALIDATION ERROR: All fields are required';
                return;
            }
            
            try {
                addDebugLog('üì° Sending POST request to create product...');
                const response = await fetch(`${API_BASE}/products`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(productData)
                });
                
                addDebugLog(`üì° Create product response status: ${response.status}`);
                const responseText = await response.text();
                addDebugLog(`üì° Response text: ${responseText.substring(0, 200)}...`);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    addDebugLog(`‚ùå JSON parse error: ${e.message}`);
                    document.getElementById('create-status').innerHTML = 
                        `‚ùå JSON PARSE ERROR\nStatus: ${response.status}\nResponse: ${responseText}`;
                    return;
                }
                
                if (response.ok) {
                    addDebugLog(`‚úÖ Product created successfully! ID: ${data.id}`);
                    document.getElementById('create-status').innerHTML = 
                        `‚úÖ PRODUCT CREATED SUCCESSFULLY!\n` +
                        `ID: ${data.id}\n` +
                        `Name: ${data.name}\n` +
                        `Price: Rp ${data.price.toLocaleString()}\n` +
                        `Stock: ${data.stock}\n\n` +
                        `Full Response:\n${JSON.stringify(data, null, 2)}`;
                } else {
                    addDebugLog(`‚ùå Create failed with status ${response.status}`);
                    document.getElementById('create-status').innerHTML = 
                        `‚ùå CREATE FAILED\n` +
                        `Status: ${response.status}\n` +
                        `Error: ${JSON.stringify(data, null, 2)}`;
                }
                
            } catch (error) {
                addDebugLog(`‚ùå Network error: ${error.message}`);
                document.getElementById('create-status').innerHTML = `‚ùå NETWORK ERROR: ${error.message}`;
            }
        }

        async function manualAPITest() {
            addDebugLog('üîß Manual API test...');
            
            const testData = {
                name: 'Manual Test Product ' + Date.now(),
                description: 'Product created via manual API test',
                price: 15000,
                stock: 30,
                category_id: 1,
                image: 'https://via.placeholder.com/300x300.png?text=Manual+Test'
            };
            
            try {
                const response = await fetch(`${API_BASE}/products`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                
                document.getElementById('manual-status').innerHTML = 
                    `Manual API Test Result:\n` +
                    `Status: ${response.status}\n` +
                    `Response: ${JSON.stringify(data, null, 2)}`;
                    
            } catch (error) {
                document.getElementById('manual-status').innerHTML = `Manual API Error: ${error.message}`;
            }
        }
    </script>
</body>
</html>
